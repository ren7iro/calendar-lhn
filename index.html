<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calendar LHN</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      background: #f9f9f9;
      color: #000;
    }
    .event {
      padding: 0.5rem 0;
      border-bottom: 1px solid #ccc;
    }
    .info-msg {
      font-size: 0.9rem;
      margin-top: 0.25rem;
    }
    .info-ended { color: gray; }
    .info-ongoing { color: red; }
    .info-upcoming { color: black; }
    .icon { font-weight: bold; margin-right: 0.25rem; }
    #datePicker {
      padding: 0.25rem;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <h1>Calendar Viewer</h1>
  <div style="margin: 1rem 0;">
    <label for="datePicker">📅 Pick a date: </label>
    <input type="date" id="datePicker" />
  </div>
  <div id="event-list">Loading...</div>

  <script>
    const csvUrl = 'https://ren7iro.github.io/calendar-lhn/data.csv';
    const STORAGE_KEY = 'calendarData';
    const STORAGE_DATE_KEY = 'calendarDataDate';

    const urlParams = new URLSearchParams(window.location.search);
    const currentDate = urlParams.get("date") || new Date().toISOString().split("T")[0];

    const picker = document.getElementById("datePicker");
    picker.value = currentDate;
    picker.addEventListener("change", () => {
      const selected = picker.value;
      if (selected) {
        window.location.search = `?date=${selected}`;
      }
    });

    function parseTime(str, date) {
      const [h, m] = str.split(':').map(Number);
      const d = new Date(date);
      d.setHours(h || 0, m || 0, 0, 0);
      return d;
    }

    function addDuration(start, durationText) {
      const d = new Date(start);
      const match = durationText.match(/(\d+)\s*(hour|hr|minute|min)/gi);
      if (!match) return d;

      match.forEach(part => {
        if (part.includes('hour')) {
          d.setHours(d.getHours() + parseInt(part));
        } else if (part.includes('min')) {
          d.setMinutes(d.getMinutes() + parseInt(part));
        }
      });

      return d;
    }

    function getDayName(dateStr) {
      const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
      const d = new Date(dateStr);
      return days[d.getDay()];
    }

    function loadCSV(url) {
      return fetch(url)
        .then(res => res.text())
        .then(text => {
          const lines = text.trim().split('\n');
          const headers = lines.shift().split(',').map(h => h.trim().toLowerCase());
          return lines.map(line => {
            const cols = line.split(',').map(c => c.trim());
            const row = {};
            headers.forEach((h, i) => row[h] = cols[i]);
            return row;
          });
        });
    }

    function formatCountdown(ms) {
      const totalSec = Math.floor(ms / 1000);
      const min = Math.floor(totalSec / 60);
      const sec = totalSec % 60;
      return `${min}m ${sec}s`;
    }

    function renderEvents(events) {
      const now = new Date();
      const baseDate = new Date(currentDate);
      const targetDay = getDayName(currentDate); // e.g. "Monday"
      const list = document.getElementById("event-list");
      list.innerHTML = '';

      const filtered = events.filter(e => {
        return (e["day"] || '').toLowerCase() === targetDay.toLowerCase();
      });

      if (filtered.length === 0) {
        list.innerHTML = 'No events for this day.';
        return;
      }

      filtered.sort((a, b) => a["start time"].localeCompare(b["start time"]));

      filtered.forEach(e => {
        const name = e["event name"];
        const startTime = parseTime(e["start time"], baseDate);
        const endTime = addDuration(startTime, e["duration"] || "15 min");

        const isEnded = now > endTime;
        const isOngoing = now >= startTime && now <= endTime;

        let infoClass = 'info-upcoming';
        let icon = '🕒';
        let msg = `${e["start time"]} (in ${formatCountdown(startTime - now)})`;

        if (isEnded) {
          infoClass = 'info-ended';
          icon = '✔️';
          msg = `${e["start time"]} - Ended`;
        } else if (isOngoing) {
          infoClass = 'info-ongoing';
          icon = '⏳';
          msg = `${e["start time"]} - Ongoing (ends in ${formatCountdown(endTime - now)})`;
        }

        const div = document.createElement('div');
        div.className = 'event';
        div.innerHTML = `
          <div><strong>${name}</strong></div>
          <div class="info-msg ${infoClass}">
            <span class="icon">${icon}</span>${msg}
          </div>
        `;
        list.appendChild(div);
      });
    }

    function loadOrCacheCSV() {
      const today = new Date().toISOString().split("T")[0];
      const cached = localStorage.getItem(STORAGE_KEY);
      const cachedDate = localStorage.getItem(STORAGE_DATE_KEY);

      if (cached && cachedDate === today) {
        try {
          renderEvents(JSON.parse(cached));
          return;
        } catch {}
      }

      loadCSV(csvUrl).then(events => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
        localStorage.setItem(STORAGE_DATE_KEY, today);
        renderEvents(events);
      });
    }

    loadOrCacheCSV();
  </script>
</body>
</html>
